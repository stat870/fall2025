---
title: "Assignment 2"
author: "Your Name"
date: "2025-09-03"
output: 
  pdf_document:
    extra_dependencies: ["float"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.pos = "H", out.extra = "", echo = TRUE)
```

## 1. 

Below are two snippets from Materials and Methods sections from peer-reviewed papers. Identify the treatment structure and design structure for both, or mention if this information is unclear or unavailable. 

### 1a. 

From "Plasma concentrations of substance P and cortisol in beef calves after castration or simulated castration" - Coetzee et al. (2008) [[link to paper](https://avmajournals.avma.org/view/journals/ajvr/69/6/ajvr.69.6.751.xml)] 

```{r echo=FALSE, fig.cap="From Coetzee et al. (2008)",fig.align='center', out.width = '90%'}
knitr::include_graphics("img/coetzee_2008.png")
```


**Treatment structure:** One-way treatment structure: castration & control.

**Design structure:** RCBD -- blocks were pairs of calves with similar scrotal circumference. 


### 1b. 

From "Maize Kernel Weight Response to Postflowering Sourceâ€“Sink Ratio" - Borras and Otegui (2001) [[link to paper](https://acsess.onlinelibrary.wiley.com/doi/abs/10.2135/cropsci2001.1816)]

```{r echo=FALSE, fig.cap="From Borras and Otegui (2001)",fig.align='center', out.width = '55%'}
knitr::include_graphics("img/borras2001.jpg")
```
**Treatment structure:** Three-way treatment structure: hybrid (DK752 and DK664), plant population (3 and 9 plants m$^2$), and pollination (restricted, hand, and open pollination).

**Design structure:** split-split-plot: plant pop in the whole plot, hybrid in the split-plot, pollination in the sub-subplot. 

## 2. 

The data in the code below correspond to a trial studying the effects of agronomic management and the timing of said agronomic management on plant height in rice. 
Studying plant height in rice is important because this trait is associated to lodging (i.e., when the plants are too tall and heavy and "fall"), which may reduce yields due to difficulty in harvesting the grain. 

The scientists were able to divide the field into equally-sized blocks that fitted all treatments (i.e., *complete blocks*). 
Then, the scientists randomly allocated the management treatments to smaller areas within the blocks. 
After that, they assigned the timings to even smaller areas of the management treatments. 
From each block-management-timing treatment combination, they were able to measure plant height twice. 

### 2a. 

**What is the treatment structure and the design structure in this experiment?** 

Answer: The treatment structure is a $7\times 3$ factorial, and the design structure is a split-plot design with sub-sampling. 

### 2b. 

**Write the statistical model that best represents the data generating process.** 

$$y_{ijkl}|b_k, w_{i(k)}, s_{j(ik)} \sim N(\mu_{ijkl}, \sigma^2_\varepsilon), \\ 
\mu_{ijkl} = \eta_{ijkl} = \eta_0 + M_i + T_j +(MT)_{ij} + b_k + w_{i(k)} + s_{j(ik)},$$
where: 

- $y_{ijkl}$ is the observation of the height of the $i$th management treatment, $j$th timing, $k$th block, and $l$th subsample out of that plot, 
- $\mu_{ijkl}$ is the expected value, 
- $\sigma^2_\varepsilon$ is the variance, 
- $\eta_{ijkl}$ is the linear predictor, 
- $\eta_0$ is the overall mean of the linear predictor, 
- $M_i$ is the effect of the $i$th management treatment, 
- $T_j$ is the effect of the $j$th timing treatment, 
- $(MT)_{ij}$ is the interaction between the $i$th management treatment and the $j$th timing treatment, 
- $b_k$ is the effect of the $k$th block, $b_k \sim N(0, \sigma^2_b)$
- $w_{i(k)}$ is the effect of the $i(k)$th whole plot, $w_{i(k)} \sim N(0, \sigma^2_w)$
- $s_{j(ik)}$ is the effect of the $j(ik)$th split plot, $w_{j(ik)} \sim N(0, \sigma^2_s)$.

### 2c. 

Fit that model to the data, check model assumptions, report all variance components, and the estimated marginal means (including some measure of uncertainty) for all time-management combinations (i.e., 32 total combinations). 

```{r warning=FALSE, message=FALSE}
library(agridat)
data("gomez.splitplot.subsample")
df <- gomez.splitplot.subsample
```

```{r}
library(tidyverse)
library(lme4)
library(emmeans)
```

```{r}
m <- lmer(height ~ time*manage + (1|rep/manage/time), data = df)
```

```{r}
plot(m)
```

```{r}
VarCorr(m)
```

```{r}
emmeans(m, ~time:manage)
```


