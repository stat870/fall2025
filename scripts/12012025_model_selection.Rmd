---
title: "Model Selection"
author: "J Lacasa"
date: "2025-11-30"
output: html_document
---


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lme4)
library(glmmTMB)
library(DHARMa)
library(glmnet)
```

## Example 1 - data generated by a designed experiment 

```{r}
dat <- agridat::ridout.appleshoots |> 
  mutate(across(c(photo,bap), ~as.factor(.)))
```

270 shoots from the columnar apple cultivar Trajan were micropropagated. 
During the rooting period, shoot tips of length 1.0-1.5 cm were cultured on media with different concentrations of the cytokinin BAP in two growth chambers with 8 or 16 hour photoperiod.
The response variable is the number of roots after 4 weeks at 22 degrees C.
Almost all of the shoots in the 8 hour photoperiod rooted. Under the 16 hour photoperiod only
about half rooted.
High BAP concentrations often inhibit root formation of apples, but perhaps not for columnar varieties.

```{r}
dat |> 
  ggplot(aes(roots))+
  geom_histogram()+
  labs(x = "Root count")+
  facet_grid(bap~photo)+
  theme_pubclean()
```

According to the experiment design, an appropriate model is 


$$y_{ijk}\sim Pois(\lambda_{ijk}), \\ \log(\lambda_{ijk}) = \eta_{ijk}= \eta_0 + BAP_i + FP_j + (BAP \times FP)_{ij}$$

```{r}
m1 <- glmmTMB(roots ~ photo * bap, 
              family = poisson(link = "log"),
              data = dat)

DHARMa::testZeroInflation(m1)
```

```{r}
m2 <- glmmTMB(roots ~ photo * bap, 
              ziformula = ~ 1,
              family = poisson(link = "log"),
              data = dat)

DHARMa::testZeroInflation(m2)
```

```{r}
summary(m2)
```

```{r}
DHARMa::simulateResiduals(m2, plot = T)
```

```{r}
m3 <- glmmTMB(roots ~ photo * bap, 
              ziformula = ~ 1,
              family = nbinom1(link = "log"),
              data = dat)

DHARMa::testZeroInflation(m3)
```

```{r}
DHARMa::simulateResiduals(m3, plot = T)
```

```{r}
m4 <- glmmTMB(roots ~ photo * bap, 
              ziformula = ~ photo,
              family = nbinom1(link = "log"),
              data = dat)

DHARMa::testZeroInflation(m4)
```

```{r}
DHARMa::simulateResiduals(m4, plot = T)
```

```{r}
AIC(m1, m2, m3, m4)
BIC(m1, m2, m3, m4)
```


## Example II - model selection 

Clinical trial with dog being the unit of record. 
These data are from a clinical trial of two treatments for lymphosarcoma in dogs. 
The study was conducted as a multicenter controlled trial. 
Dogs meeting the eligibility criteria for entry into the trial had the tumor surgically removed and then were randomly assigned to one of four treatment group, no treatment, radiation only, chemotherapy only and both radiation and chemotherapy. 
Dogs were randomly assigned with each center, so the total number of dogs on each treatment group are not exactly equal for all treatments, each dog was followed from the time of treatment until it dies from a relapse of the lymphosarcoma or was lost to follow up and the time to the occurrence of either of those was recorded. 

An appropriate model would be some variation of 

$$y_{ijkl} \sim Bernoulli(p_{ijkl}), \\ \text{logit}(p_{ijkl}) = \eta_{ijkl} = \eta_0 + R_i + Ch_j + (R \times Ch)_{ij} + \beta_{1 ij} \cdot age_{ijk} + u_k, \\ u_k \sim N(0, \sigma^2_{clinic}).$$


```{r}
url <- "https://raw.githubusercontent.com/stat870/fall2025/refs/heads/main/data/lympho.csv"
dat <- read.csv(url) |> 
  mutate(across(c(rad, chemo, died, clinic), ~ as.factor(.)))

dat |> 
  ggplot(aes(months))+
  geom_histogram()+
  facet_grid(rad~chemo)+
  theme_pubclean()
```

```{r}
m1 <- glmmTMB(died ~ age * rad * chemo + (1|clinic),
              family = binomial(link = "logit"),
              data = dat)
m2 <- glmmTMB(died ~ age + rad * chemo + (1|clinic),
              family = binomial(link = "logit"),
              data = dat)
m3 <- glmmTMB(died ~ age * rad * chemo - age:rad:chemo + (1|clinic),
              family = binomial(link = "logit"),
              data = dat)
m4 <- glmmTMB(died ~ age * rad * chemo - age:rad:chemo + (1|clinic),
              family = binomial(link = "logit"),
              data = dat)

AIC(m1, m2, m3)
```

```{r}
X <-  model.matrix(~ 0 + clinic + age*rad*chemo, data = dat)
elastic_net <- 
  glmnet(x = X,
         y = dat$died,
         family = "binomial",
         alpha = 0.5,
         standardize  = TRUE)

x <- -log(elastic_net$lambda[length(elastic_net$lambda)])
y <- elastic_net$beta[, length(elastic_net$lambda)]
labs <- names(y)

plot(elastic_net, xvar="lambda");text(x, y, labels=labs)
```
```{r}
elastic_net_cv <- 
  cv.glmnet(x = X,
            y = dat$died,
            family = "binomial",
            alpha = 0.5,
            standardize  = TRUE)
plot(elastic_net_cv)
```

## Example III 

A clinical trial, with the cow being the unit of records. 
A clinical trial of the effect of prostaglandin administration at the start of the breeding period was carried out in three North Carolina dairy herds. 
On each of the three farms, the producer determined when he was ready to start breeding cows in his herd and at that time, cows were randomly assigned to receive a single injection of prostaglandin or a placebo. 
These cows were followed until they conceived or were culled. In addition to evaluating the effect of treatment on reproductive performance, three other factors were considered (parity, body condition score and herd). 

The dataset includes the following variables:

- `preg`: pregnant (1), or not pregnant (0) 
- `herd`:herd ID 
- `cow`: cow ID
- `tx`: treated with prostaglandin (1) or not treated (0) 
- `lact`: lactation #  
- `thin`: body condition -- thin (1) or not thin (0) 
- `dar`: days at risk (with low body fat) -- count 


An appropriate model would be some variation of 

$$y_{ijkl} \sim Bernoulli(p_{ijkl}), \\ \text{logit}(p_{ijkl}) = \eta_{ijkl} = \eta_0 + T_i + Thin_j + (T \times Thin)_{ij} + \beta_{1 ij} \cdot lact_{ijk} + u_k, \\ u_k \sim N(0, \sigma^2_{herd}).$$


```{r}
url <- "https://raw.githubusercontent.com/stat870/fall2025/refs/heads/main/data/pgtrial.csv"
dat <- read.csv(url) |> 
  mutate(across(c(herd:tx,thin), ~ as.factor(.)))
```

```{r}
X <- model.matrix(~ 0 + tx * lact * thin + herd, data = dat)
elastic_net <- 
  glmnet(x = X,
         y = dat$preg,
         family = "binomial",
         alpha = 0.5,
         standardize  = TRUE)

x <- -log(elastic_net$lambda[length(elastic_net$lambda)])
y <- elastic_net$beta[, length(elastic_net$lambda)]
labs <- names(y)

plot(elastic_net, xvar="lambda");text(x, y, labels=labs)
```

```{r}
elastic_net_cv <- 
  cv.glmnet(x = X,
            y = dat$preg,
            family = "binomial",
            alpha = 0.5,
            standardize  = TRUE)
plot(elastic_net_cv)
```

## Example IV 

```{r}
# install.packages("BiocManager")
# BiocManager::install("BiocParallel")
library(oosse)


data(Brassica)
#Linear model
fitFunLM = function(y, x){lm.fit(y = y, x = cbind(1, x))}
predFunLM = function(mod, x) {cbind(1,x) %*% mod$coef}
y = Brassica$Pheno$Leaf_8_width
R2lm = R2oosse(y = Brassica$Pheno$Leaf_8_width, x = Brassica$Expr[, 1:10],
fitFun = fitFunLM, predFun = predFunLM, nFolds = 10)

```

